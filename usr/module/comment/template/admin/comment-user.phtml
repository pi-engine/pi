<?php
$this->backbone();
$this->css($this->assetModule('css/admin.css'));

// User data
$user = $comment['user'];
// Count
$count = $comment['count'];
// Comment list generated by comment module:
// id, time, content, IP
$posts = $comment['posts'];
// Pagination object
$paginator = $comment['paginator'];
$active = $comment['active'];
?>

<form name="comment-user" method="GET" action="<?php echo $url; ?>" style="margin-top: 10px" class="form-inline">
    <input type="text" name="keyword" value="<?php echo $keyword; ?>" placeholder="<?php echo _a('Type user id or identity'); ?>">
    <button type="submit" class="btn"><?php echo _a('Submit'); ?></button>
</form>
<div id="pi-js-comment">
    <?php
        if ($posts) {
    ?>
    <div class="pi-comment-batch-operation">
        <input type="checkbox" class="check-all" style="margin-right: 20px">
    <?php
        if (0 === $active || null === $active) {
    ?>
        <input type="button" name="enable" class="btn disabled" value="<?php echo _a('Enable'); ?>">
    <?php
        }
        if (1 === $active || null === $active) {
    ?>
        <input type="button" name="disable" class="btn disabled" value="<?php echo _a('Disable'); ?>">
    <?php
        }
    ?>
        <input type="button" name="delete" class="btn disabled" value="<?php echo _a('Delete'); ?>">
    </div>

    <div class="pi-comment-list">
        <table style="width: 100%" class="table table-striped">
        <?php 
            foreach ($posts as $post) {
                $post['active'] = (int) $post['active'];
        ?>
            <tr>
                <td style="width: 30px">
                    <input type="checkbox" value="<?php echo $post['id']; ?>" class="check-one">
                </td>
                <td style="text-align: center; width: 50px"><?php echo $user['avatar']; ?></td>
                <td style="width: 100px">
                    <a class="<?php echo 0 === $post['active'] && 0 !== $active ? ' muted' : ''; ?>" href="<?php echo $user['url']; ?>">
                        <strong><?php echo _escape($user['name']); ?></strong>
                    </a>
                    <div class="muted"><?php echo _escape($post['ip']); ?></div>
                </td>
                <td>
                    <a class="pi-comment-article-title<?php echo 0 === $post['active'] && 0 !== $active ? ' muted' : ''; ?>" target="_blank" href="<?php echo $post['target']['url']; ?>" title="<?php echo _escape($post['target']['title']); ?>">
                        <strong><?php echo _escape($post['target']['title']); ?></strong>
                    </a>
                    <div class="pi-comment-content<?php echo 0 === $post['active'] && 0 !== $active ? ' muted' : ''; ?>">
                        <?php echo $post['content']; ?>
                    </div>
                    <div class="one-action">
                    <?php
                        foreach ($post['operations'] as $op => $value) {
                            $class = '';
                            switch ($op) {
                                case 'approve':
                                    $class = 'icon-ban-circle';
                                    break;
                                case 'edit':
                                    $class = 'icon-pencil';
                                    break;
                                case 'delete':
                                    $class = 'icon-trash';
                                    break;
                                case 'reply':
                                    $class = 'icon-share-alt';
                                    break;
                            }
                    ?>
                        <span class="operation">
                            <a class="muted" href="<?php echo $value['url']; ?>"<?php echo 'delete' == $op ? sprintf(' onclick="return confirm(\'%s\')"', __('Are you sure to delete this comment?')) : ''; ?>>
                                <i class="<?php echo $class; ?>" style="text-decoration: none"></i>
                                    <?php echo _escape($value['title']); ?>
                            </a>
                        </span>
                    <?php
                        }
                    ?>
                    </div>
                </td>
                <td style="width: 140px" class="muted"><?php echo _date($post['time']); ?></td>
                <td style="width: 60px">
                <?php if (0 === $post['active'] && 0 !== $active) {
                ?>
                    <span style="color: #999999"><strong><?php echo _a('Pending'); ?></strong></span>
                <?php
                }
                ?>
                </td>
            </tr>
        <?php 
            }
        ?>
        </table>
    </div>
    <?php
        } else {
    ?>
    <div class="pi-comment-none"><?php echo _a('No comments available yet.'); ?></div>
    <?php
        }
    ?>

    <?php
        if ($posts && $paginator) {
            echo $this->pagination($paginator);
        }
    ?>
</div>

<script>
(function($) {
    var page = {
        url : "<?php echo $this->url('', array('controller' => 'list', 'action' => 'index')); ?>".replace(/index\/$/,""),
        el  : $("#pi-js-comment"),
        $   : function(selector) {
            return this.el.find(selector);
        },
        init : function() {
            _.bindAll(this);
            this.$(".operation a").mouseover(this.removeOperationClass);
            this.$(".operation a").mouseout(this.addOperationClass);
            this.$(".check-all").click(this.checkAll);
            this.$(".check-one").click(this.clickOne);
            this.$("[name=enable]").click(this.batchOperation);
            this.$("[name=disable]").click(this.batchOperation);
            this.$("[name=delete]").click(this.batchOperation);
        },
        removeOperationClass    : function(e) {
            var el = $(e.target).parents(".operation");
            el.find("a").removeClass("muted");
        },
        addOperationClass       : function(e) {
            var el = $(e.target).parents(".operation");
            el.find("a").addClass("muted");
        },
        checkAll : function() {
            var flag = this.$(".check-all").prop("checked");
            this.$(".check-one").prop("checked", flag).each(function() {
                var tr = $(this).parents("tr:first");
                if (flag) {
                    tr.addClass("info");
                } else {
                    tr.removeClass("info");
                }
            });
            this.toggleBulk();
        },
        batchOperation : function(e) {
            var url = "<?php echo $this->url('', array('controller' => 'post', 'action' => 'index')); ?>".replace(/index\/$/,"");
            var el = $(e.target);
            var name = el.attr('name');
            var operation, flag;
            var id = [],
                fn = function() {
                    this.$(".check-one:checked").each(function() {
                        id.push($(this).val()); 
                    });
                    if ('enable' == name || 'disable' == name) {
                        operation = 'batch-approve';
                        if ('enable' == name) {
                            flag = 1;
                        } else {
                            flag = 0;
                        }
                    } else {
                        operation = 'batch-' + name;
                    }
                    if ('batch-approve' == operation) {
                        location.href = url + operation + "/id/" + id.join(",") + "/flag/"
                                      + flag + "?redirect=" + this.encodeUrl();
                    } else {
                        location.href = url + operation + "/id/" + id.join(",") + "?redirect="
                                      + this.encodeUrl();
                    }
                };
            if (name) {
                if (name == "delete") {
                    if (confirm("<?php echo _a('Are you sure delete these comments?'); ?>")) {
                        fn.call(this);
                    }
                } else {
                    fn.call(this);
                }
            }
        },
        clickOne : function(e) {
            var el = $(e.target),
                tr = el.parents("tr:first");
            if (el.prop("checked")) {
                tr.addClass("info");
            } else {
                tr.removeClass("info");
            }
            this.toggleBulk();
        },
        toggleBulk : function() {
            var enableObj = this.$("[name=enable]");
            var disableObj = this.$("[name=disable]");
            var deleteObj = this.$("[name=delete]");
            if (this.$(".check-one:checked").length) {
                deleteObj.removeClass("disabled");
                if (enableObj) {
                    enableObj.removeClass("disabled");
                }
                if (disableObj) {
                    disableObj.removeClass("disabled");
                }
            } else {
                deleteObj.addClass("disabled");
                if (enableObj) {
                    enableObj.addClass("disabled");
                }
                if (disableObj) {
                    disableObj.addClass("disabled");
                }
            }
        },
        oneAction : function(e) {
            var el = $(e.target),
                id = el.parents("tr:first").attr("data-id"),
                val = el.attr("data-value"),
                status=el.attr("data-status");
            if (val == "delete") {
                if (confirm("<?php echo _a('Are you sure delete this article?'); ?>")) {
                    location.href = this.url + "delete?id=" + id + "&from=" + this.encodeUrl(); 
                }
            } else if (status) {
                location.href = this.url + val + "?id=" + id + "&status=" 
                              + status + "&from=" + this.encodeUrl();
            } else {
                location.href = this.url + val + "?id=" + id + "&from=" + this.encodeUrl();
            }
        },
        encodeUrl : function() {
            return encodeURIComponent(location.href);
        }
    }
    page.init();
})(jQuery)
</script>
