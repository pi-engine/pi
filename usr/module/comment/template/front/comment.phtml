<?php
// Skip if comment is not available
if (!Pi::comment()->active()) {
    return;
}

// Load comment data
// - root[id, module, category, item, active]
// - count
// - posts[id, uid, IP, content, time, active]
// - users[uid, name, avatar, url]
// - url_list
// - url_submit
// - url_ajax

$data = Pi::api('comment')->load(
    $this->url()->routeMatch()
);
if (!$data
    || (isset($data['root']['active']) && empty($data['root']['active']))
) {
    return;
}

if (!empty($data['root']['id'])) {
    $formData = array(
        'root' => $data['root']['id']
    );
} else {
    $formData = array(
        'module'    => $data['root']['module'],
        'category'  => $data['root']['category'],
        'item'      => $data['root']['item'],
    );
}
$formData['redirect'] = $this->url()->requestUri(true);

$form = Pi::service('comment')->getForm($formData);
include $this->templateComponent('form');

if ($data['posts']) {
?>
    <div class="pi-comment-header">
        <dl><?php _e('Recent comments'); ?></dl>
        <dl class="dl-horizontal">
            <dt><?php _e('Total:') ?></dt>
            <dd><?php echo $data['count']; ?></dd>
            <?php if ($data['count']) { ?>
                <dt><?php _e('Read more:') ?></dt>
                <dd>
                    <a href="<?php echo $data['url_list']; ?>" title="<?php _e('Read more') ?>" target="_blank">
                        <?php _e('Read more'); ?>
                    </a>
                </dd>
            <?php } ?>
        </dl>
    </div>
    <div class="pi-comment-list">
<?php
    foreach ($data['posts'] as $post) {
?>
        <dl class="dl-horizontal pi-comment-item">
            <dt><?php _e('User:');?></dt>
            <dd><a href="<?php echo $post['user']['url']; ?>" target="_blank" title="<?php echo $post['user']['name']; ?>">
                    <?php echo $post['user']['name']; ?>
                </a>
            </dd>
            <dt>&nbsp;</dt>
            <dd><?php echo $post['user']['avatar']; ?></dd>

            <dt><?php _e('IP:');?></dt>
            <dd><?php echo $post['ip']; ?></dd>

            <dt><?php _e('Time:');?></dt>
            <dd><?php echo _date($post['time']); ?></dd>

            <dt><?php _e('Content:');?></dt>
            <dd><?php echo $post['content']; ?></dd>

            <dt><?php _e('Operations:'); ?></dt>
            <dd>
                <?php if (!empty($post['operations'])) { ?>
                    <?php foreach ($post['operations'] as $key => $op) { ?>
                        <a href="<?php echo $op['url']; ?>" title="<?php echo _escape($op['title']); ?>" target="_blank">
                            <?php echo _escape($op['title']); ?>
                        </a>
                    <?php } ?>
                <?php } else { ?>
                    <a href="<?php echo $post['url']; ?>" title="<?php _e('More details'); ?>" target="_blank">
                        <?php _e('More details'); ?>
                    </a>
                <?php } ?>
            </dd>
        </dl>
<?php
    }
?>
    </div>
<?php
}
?>
<!--
<form name="comment-post" method="POST" action="<?php echo $data['url_submit']; ?>">
<dl>
    <dt><?php _e('Post a comment:'); ?></dt>
    <dd><textarea name="content"></textarea></dd>
    <?php if ($data['root']['id']) { ?>
        <input type="hidden" name="root" value="<?php echo $data['root']['id']; ?>" />
    <?php } else { ?>
        <input type="hidden" name="module" value="<?php echo $data['root']['module']; ?>" />
        <input type="hidden" name="category" value="<?php echo $data['root']['category']; ?>" />
        <input type="hidden" name="item" value="<?php echo $data['root']['item']; ?>" />
    <?php } ?>
    <input type="hidden" name="redirect" value="<?php echo $this->url()->requestUri(true); ?>" />
    <input type="submit" value="<?php _e('Submit'); ?>" />
</dl>
</form>
//-->