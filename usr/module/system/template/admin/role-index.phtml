<?php
$this->css($this->assetModule('script/system-ui.css'));
$this->angular(array(
    'angular-route.js',
    'angular-translate.js',
    'pi-form.js'
));
?>
<div ng-view ng-app="systemRoleModule"></div>
<script>
var systemRoleModule = angular.module('systemRoleModule', ['ngRoute', 'pascalprecht.translate', 'piForm']);
var systemRoleModuleConfig = {
    urlRoot: '<?php echo $this->url('', array('controller' => 'role')); ?>',
    assetRoot: '<?php echo $this->assetModule('ng-template/admin/'); ?>',
    t: {
        ADMIN_TITLE: '<?php _e('Admin roles'); ?>',
        ADMIN_ADD: '<?php _e('Add admin role'); ?>',
        FRONT_TITLE: '<?php _e('Front roles'); ?>',
        FRONT_ADD: '<?php _e('Add front role'); ?>',
        ROLE_ADD: '<?php _e('Add role'); ?>',
        DELETE: '<?php _e('Delete'); ?>',
        EDIT: '<?php _e('Edit permission'); ?>',
        NAME: '<?php _e('Name'); ?>',
        TITLE: '<?php _e('Title'); ?>',
        USER_COUNT: '<?php _e('User in role'); ?>',
        STATUS: '<?php _e('Status'); ?>',
        ACTIVE: '<?php _e('Active'); ?>',
        INACTIVE: '<?php _e('Inactive'); ?>',
        ACTION: '<?php _e('Action'); ?>',
        ROLE_NAME: '<?php _e('Unique name'); ?>',
        ROLE_TITLE: '<?php _e('Title'); ?>',
        SUBMIT: '<?php _e('Submit'); ?>',
        CANCEL: '<?php _e('Cancel'); ?>',
        REQUIRED: '<?php _e('Required'); ?>',
        TYPE: '<?php _e('Type'); ?>',
        FRONT: '<?php _e('Front'); ?>',
        ADMIN: '<?php _e('Admin'); ?>',
        ROLE_NAME_TOKEN: '<?php _e('Role name is aleady token'); ?>',
        DELETE_CONFIRM: '<?php _e('Are you sure delete this role?'); ?>'
    }
}
</script>
<script>
systemRoleModule.config(function($translateProvider, $routeProvider) {
    $translateProvider.translations(systemRoleModuleConfig.t);
    $routeProvider.otherwise({
        templateUrl: systemRoleModuleConfig.assetRoot + 'role-index.html',
        controller: 'RoleCtrl'
    });
}).directive('piFocus', function() {
    return {
        restrict: 'A',
        link: function(scope, element, attr) {
            scope.$watch(attr.piFocus, function(value) {
                if (value) {
                    element[0].focus();
                }
            });
        }
    }
}).service('server', function($http) {
    var root = systemRoleModuleConfig.urlRoot;
    var isFile = function(obj) {
        return Object.prototype.toString.apply(obj) === '[object File]';
    };
    //emulate jQuery post
    $http.defaults.headers.post['Content-Type'] = 'application/x-www-form-urlencoded;charset=utf-8';
    $http.defaults.transformRequest = [function(d) {
        return angular.isObject(d) && !isFile(d) ? $.param(d) : d;
    }];
    this.root = root;
    this.get = function() {
        return $http.get(root + 'list');
    }
    this.add = function(role) {
        return $http.post(root + 'add', role);
    };
    this.putTitle = function(role) {
        $http.post(root + 'rename', {
            id: role.id,
            title: role.title
        });
    };
    this.putActive = function(role) {
        return $http.post(root + 'activate', {
            id: role.id
        });
    };
    this.remove = function(role) {
        return $http.post(root + 'delete', {
            id: role.id
        });
    };
}).controller('RoleCtrl', function($scope, server) {
    server.get().success(function(data) {
        var frontRoles = data.frontRoles;
        var adminRoles = data.adminRoles;
        var parse = function(item) {
            item.editTitle = 0;
            item.originTitle = item.title;
        };
        angular.forEach(frontRoles, parse);
        angular.forEach(frontRoles, parse);
        $scope.frontRoles = data.frontRoles;
        $scope.adminRoles = data.adminRoles;
    });
    $scope.uniqueUrl = server.root + 'checkExist';
    $scope.cancelModal = function() {
        $scope.entity = null;
    }
    $scope.modal = function(type) {
        $scope.entity = {
            section: type,
            active: 1
        };
    }
    $scope.addRoleAction = function() {
        server.add($scope.entity).success(function(data) {
            $scope.alert = data;
            if (data.status) {
                var role = data.data;
                role.count = role.count || 0;
                if (role.section == 'front') {
                    $scope.frontRoles.push(role);
                } else {
                    $scope.adminRoles.push(role);
                }
                $scope.entity = '';
            }
        });
    }
    $scope.renameAction = function(role) {
        if (role.title == '') {
            role.title = role.originTitle;
        }
        if (role.title != role.originTitle) {
            server.putTitle(role);
        }
        role.editTitle = 0;
    }
    $scope.activeAction = function(role) {
        server.putActive(role).success(function(data) {
            $scope.alert = data;
            if (data.status) {
                role.active = data.data;
            }
        });
    }
    $scope.deleteAction = function(role, index) {
        if (!confirm(systemRoleModuleConfig.t.DELETE_CONFIRM)) return;
        server.remove(role).success(function(data) {
            $scope.alert = data;
            if (data.status) {
                if (role.section == 'front') {
                    $scope.frontRoles.splice(index, 1);
                } else {
                    $scope.adminRoles.splice(index, 1);
                }
            }
        });
    }
    $scope.clearAlert = function() {
        $scope.alert = '';
    }
});
</script>